<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONYX STALKER ULTRA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #04080c; --surface: #0c141d; --accent: #1a98ff; --text: #f2f4f6;
            --focus-glow: 0 0 40px rgba(26, 152, 255, 0.4);
        }
        body, html { margin:0; padding:0; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow:hidden; height:100vh; }
        
        /* SIDEBAR */
        aside { position:fixed; left:0; top:0; bottom:0; width:80px; background:rgba(0,0,0,0.5); backdrop-filter:blur(20px); display:flex; flex-direction:column; align-items:center; padding-top:40px; z-index:1000; }
        .nav-item { width:50px; height:50px; margin-bottom:25px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#555; cursor:pointer; }
        
        /* SPATIAL FOCUS */
        .focusable { transition: 0.3s cubic-bezier(0.2,0,0.2,1); outline:none; border:2px solid transparent; }
        .focusable.focused { transform:scale(1.08); border-color:white; box-shadow:var(--focus-glow); background:rgba(26,152,255,0.1); z-index:100; }
        .nav-item.focused { color:var(--accent); border-color:var(--accent); }

        /* VIEWS */
        main { margin-left:80px; height:100vh; overflow:hidden; position:relative; }
        .view { position:absolute; inset:0; display:none; padding:40px 60px; box-sizing:border-box; overflow-y:auto; }
        .view.active { display:block; animation:fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* AUTH BOX */
        .auth-card { max-width:480px; margin:40px auto; background:var(--surface); padding:45px; border-radius:24px; border:1px solid #1a252f; box-shadow:0 20px 50px rgba(0,0,0,0.5); }
        input { width:100%; padding:16px; margin:10px 0; background:#04080c; border:1px solid #222; color:white; border-radius:12px; font-size:1rem; box-sizing:border-box; }
        .btn { width:100%; padding:20px; background:var(--accent); color:white; border:none; font-weight:800; border-radius:14px; margin-top:20px; cursor:pointer; font-size:1.1rem; }

        /* GRID */
        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:25px; }
        .item-card { height:160px; background:var(--surface); border-radius:16px; display:flex; align-items:flex-end; padding:15px; background-size:cover; background-position:center; border:2px solid transparent; }
        .item-label { width:100%; padding:10px; background:rgba(0,0,0,0.8); border-radius:0 0 16px 16px; font-size:0.9rem; font-weight:bold; }

        /* PLAYER */
        #player-layer { position:fixed; inset:0; background:#000; z-index:5000; display:none; }
        video { width:100%; height:100%; }

        .loader { position:fixed; inset:0; background:var(--bg); z-index:9999; display:none; align-items:center; justify-content:center; font-weight:900; color:var(--accent); letter-spacing:4px; }
    </style>
</head>
<body>

    <aside>
        <div class="nav-item focusable" onclick="navTo('home')">üè†</div>
        <div class="nav-item focusable" onclick="navTo('cats')">üì∫</div>
        <div class="nav-item focusable" onclick="navTo('login')">‚öôÔ∏è</div>
    </aside>

    <div id="loading" class="loader">ONYX PORTAL AUTHENTICATING...</div>

    <main>
        <!-- LOGIN SECTION -->
        <section id="view-login" class="view active">
            <div class="auth-card">
                <h1 style="margin:0 0 10px 0;">Stalker Portal</h1>
                <p style="color:#666; margin-bottom:30px;">Premium MAG Emulation</p>
                <input type="text" id="url" class="focusable" placeholder="Portal URL (http://domain.com/c/)">
                <input type="text" id="mac" class="focusable" placeholder="MAC (00:1A:79:XX:XX:XX)">
                <input type="text" id="sn" class="focusable" placeholder="Serial Number">
                <input type="text" id="id1" class="focusable" placeholder="Device ID 1">
                <input type="text" id="id2" class="focusable" placeholder="Device ID 2">
                <button class="btn focusable" onclick="doAuth()">CONNECT PORTAL</button>
                <p id="status" style="text-align:center; color:#ff4b4b; margin-top:15px;"></p>
            </div>
        </section>

        <!-- CATEGORIES SECTION -->
        <section id="view-cats" class="view">
            <h1 id="h-cats">Live Channels</h1>
            <div class="grid" id="grid-cats"></div>
        </section>

        <!-- CHANNELS SECTION -->
        <section id="view-items" class="view">
            <h1 id="h-items">Select Channel</h1>
            <div class="grid" id="grid-items"></div>
        </section>
    </main>

    <div id="player-layer">
        <video id="v-engine" controls autoplay></video>
        <button class="focusable" onclick="closePlayer()" style="position:fixed; top:30px; left:30px; padding:15px 30px; background:rgba(0,0,0,0.6); color:white; border-radius:12px; font-weight:bold;">BACK</button>
    </div>

<script>
    const PROXY = "https://layasync-proxy.layasync.workers.dev/?url=";
    let auth = { url:'', mac:'', sn:'', id1:'', id2:'', token:'' };
    let currentFocus = null;

    // --- SPATIAL NAV SYSTEM ---
    function setFocus(el) {
        if (!el) return;
        if (currentFocus) currentFocus.classList.remove('focused');
        currentFocus = el;
        currentFocus.classList.add('focused');
        currentFocus.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function moveFocus(dir) {
        const all = Array.from(document.querySelectorAll('.view.active .focusable, aside .focusable, #player-layer .focusable'));
        const curRect = currentFocus.getBoundingClientRect();
        let target = null; let minDistance = Infinity;

        all.forEach(el => {
            if (el === currentFocus) return;
            const r = el.getBoundingClientRect();
            let match = false;
            if (dir === 'up' && r.bottom <= curRect.top + 5) match = true;
            if (dir === 'down' && r.top >= curRect.bottom - 5) match = true;
            if (dir === 'left' && r.right <= curRect.left + 5) match = true;
            if (dir === 'right' && r.left >= curRect.right - 5) match = true;

            if (match) {
                const dist = Math.hypot(r.left - curRect.left, r.top - curRect.top);
                if (dist < minDistance) { minDistance = dist; target = el; }
            }
        });
        if (target) setFocus(target);
    }

    window.addEventListener('keydown', e => {
        const k = e.keyCode;
        if ([37,38,39,40,13,10009].includes(k)) e.preventDefault();
        if (k === 38) moveFocus('up');
        if (k === 40) moveFocus('down');
        if (k === 37) moveFocus('left');
        if (k === 39) moveFocus('right');
        if (k === 13) currentFocus.click();
        if (k === 10009) closePlayer();
    });

    // --- STALKER API LOGIC ---
    async function callApi(action, type = '', params = '') {
        const baseUrl = auth.url.endsWith('/') ? auth.url : auth.url + '/';
        const target = `${baseUrl}load.php?action=${action}&type=${type}${params}&JsHttpRequest=1-xml`;
        const proxyUrl = `${PROXY}${encodeURIComponent(target)}&mac=${auth.mac}&sn=${auth.sn}&id1=${auth.id1}&id2=${auth.id2}&token=${auth.token}`;
        
        const res = await fetch(proxyUrl);
        const text = await res.text();
        
        try {
            // Clean the Stalker specific wrapper
            const jsonStr = text.substring(text.indexOf('{"'), text.lastIndexOf('}') + 1);
            const data = JSON.parse(jsonStr);
            return data.js;
        } catch (e) {
            console.error("API Error", text);
            throw new Error("Invalid Response");
        }
    }

    async function doAuth() {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('status').innerText = "";
        
        auth.url = document.getElementById('url').value;
        auth.mac = document.getElementById('mac').value.toUpperCase();
        auth.sn = document.getElementById('sn').value;
        auth.id1 = document.getElementById('id1').value;
        auth.id2 = document.getElementById('id2').value;

        try {
            const handshake = await callApi('stb', 'handshake');
            if (handshake && handshake.token) {
                auth.token = handshake.token;
                await callApi('stb', 'get_profile');
                navTo('cats');
            } else {
                throw new Error("Handshake Failed");
            }
        } catch (e) {
            document.getElementById('status').innerText = "Auth Failed: Check Serial/IDs/MAC";
        }
        document.getElementById('loading').style.display = 'none';
    }

    function navTo(view) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        if (view === 'cats') loadCategories();
        setTimeout(() => setFocus(document.querySelector('.view.active .focusable')), 150);
    }

    async function loadCategories() {
        try {
            const cats = await callApi('itv', 'get_categories');
            const grid = document.getElementById('grid-cats');
            grid.innerHTML = '';
            cats.forEach(c => {
                const d = document.createElement('div');
                d.className = 'item-card focusable';
                d.style.height = '80px';
                d.innerHTML = `<div style="width:100%; text-align:center; font-weight:900;">${c.category_name}</div>`;
                d.onclick = () => loadChannels(c.id);
                grid.appendChild(d);
            });
        } catch(e) {}
    }

    async function loadChannels(catId) {
        document.getElementById('loading').style.display = 'flex';
        const data = await callApi('itv', 'get_ordered_list', `&category=${catId}`);
        const grid = document.getElementById('grid-items');
        grid.innerHTML = '';
        data.data.forEach(ch => {
            const d = document.createElement('div');
            d.className = 'item-card focusable';
            d.style.backgroundImage = `url(${ch.logo})`;
            d.innerHTML = `<div class="item-label">${ch.name}</div>`;
            d.onclick = () => playStream(ch.cmd);
            grid.appendChild(d);
        });
        navTo('items');
        document.getElementById('loading').style.display = 'none';
    }

    async function playStream(cmd) {
        const link = await callApi('itv', 'get_link', `&cmd=${encodeURIComponent(cmd)}`);
        document.getElementById('player-layer').style.display = 'block';
        const v = document.getElementById('v-engine');
        v.src = link;
        v.play();
    }

    function closePlayer() {
        const v = document.getElementById('v-engine');
        v.pause(); v.src = "";
        document.getElementById('player-layer').style.display = 'none';
    }

    setFocus(document.querySelector('.focusable'));
</script>
</body>
</html>