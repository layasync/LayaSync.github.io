<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONYX PRIME - IR OPTIMIZED</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #060d14;
            --surface: #101a23;
            --accent: #1a98ff;
            --text: #f2f4f6;
            --text-dim: #8197a4;
            --focus-glow: 0 0 40px rgba(26, 152, 255, 0.5);
            --card-w: 300px;
            --card-h: 169px;
        }

        body, html {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh;
            cursor: default; /* Shows the IR cursor so user can see what they are hitting */
        }

        /* --- PREMIUM SIDEBAR --- */
        aside {
            position: fixed; left: 0; top: 0; bottom: 0; width: 90px;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(30px);
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 40px; z-index: 1000; border-right: 1px solid rgba(255,255,255,0.05);
        }

        .nav-item {
            width: 56px; height: 56px; margin-bottom: 25px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim); cursor: pointer; transition: 0.3s cubic-bezier(0.2, 0, 0.2, 1);
        }

        /* --- GLOBAL FOCUSABLE SYSTEM --- */
        .focusable { 
            transition: 0.3s cubic-bezier(0.2, 0, 0.2, 1); 
            outline: none; 
            border: 2px solid transparent; 
            box-sizing: border-box;
        }
        
        /* The Premium "Game" Focus State */
        .focusable.focused {
            transform: scale(1.1);
            border-color: white !important;
            box-shadow: var(--focus-glow);
            z-index: 100;
            background: rgba(255,255,255,0.1);
        }

        .nav-item.focused { color: var(--accent); border-color: var(--accent) !important; }
        .nav-item svg { width: 26px; height: 26px; fill: currentColor; }

        /* --- VIEWS --- */
        main { margin-left: 90px; height: 100vh; overflow: hidden; position: relative; }
        .view { position: absolute; inset: 0; display: none; padding: 40px 60px; box-sizing: border-box; overflow-y: auto; }
        .view.active { display: block; }

        /* HERO AREA */
        .hero {
            height: 65vh; margin: -40px -60px 40px -60px; position: relative;
            background-size: cover; background-position: center;
            display: flex; align-items: center; padding: 0 80px;
        }
        .hero::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, var(--bg) 10%, transparent 80%),
                        linear-gradient(0deg, var(--bg) 0%, transparent 40%);
        }
        .hero-content { position: relative; z-index: 10; max-width: 600px; }
        .hero-title { font-size: 4rem; font-weight: 900; margin: 0; letter-spacing: -2px; }

        /* ROWS & CARDS */
        .row-title { font-size: 1.5rem; font-weight: 700; margin: 40px 0 15px 0; display: flex; align-items: center; gap: 12px; }
        .row-title::before { content: ''; width: 4px; height: 24px; background: var(--accent); border-radius: 2px; }
        
        .scroller { display: flex; gap: 20px; overflow-x: visible; padding: 15px 5px; }
        
        .card {
            min-width: var(--card-w); height: var(--card-h); background: var(--surface);
            border-radius: 14px; cursor: pointer; flex-shrink: 0;
            background-size: cover; background-position: center;
            display: flex; align-items: flex-end; border: 2px solid rgba(255,255,255,0.05);
        }
        .card-label { 
            width: 100%; padding: 15px; background: linear-gradient(0deg, rgba(0,0,0,0.9), transparent);
            font-weight: 600; border-radius: 0 0 14px 14px; font-size: 0.9rem;
        }

        /* GRID VIEW */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }

        /* PLAYER */
        #player-layer { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; }
        video { width: 100%; height: 100%; }

        /* LOADER */
        .loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--accent); letter-spacing: 4px; }
    </style>
</head>
<body>

    <aside>
        <div class="nav-item focusable" data-page="home"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>
        <div class="nav-item focusable" data-page="movies"><svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg></div>
        <div class="nav-item focusable" data-page="shows"><svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/></svg></div>
        <div class="nav-item focusable" data-page="login"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
    </aside>

    <div id="loader" class="loader">ONYX PREMIUM</div>

    <main id="scroll-anchor">
        <!-- HOME -->
        <section id="view-home" class="view active">
            <div class="hero" id="home-hero" style="background-image: url('https://image.tmdb.org/t/p/original/mDeS9FC90oIPasvqiYqSPSqz17r.jpg');">
                <div class="hero-content">
                    <h1 id="hero-title">Onyx IPTV</h1>
                    <p id="hero-desc" style="color:var(--text-dim); font-size:1.2rem; margin:20px 0;"></p>
                    <button class="focusable" id="hero-play" style="padding:18px 45px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:800; cursor:pointer;">â–¶ WATCH NOW</button>
                </div>
            </div>
            <div class="row-title">Recently Added</div>
            <div class="scroller" id="row-server"></div>
            <div class="row-title">Trending Globally</div>
            <div class="scroller" id="row-trending"></div>
        </section>

        <!-- GRID -->
        <section id="view-lib" class="view">
            <h1 id="lib-title" style="font-size:3rem; margin:0 0 30px 0;">Movies</h1>
            <div class="grid" id="lib-grid"></div>
        </section>

        <!-- SETUP -->
        <section id="view-login" class="view">
            <div style="max-width:400px; margin: 80px auto; background: var(--surface); padding: 50px; border-radius: 20px;">
                <h2>Xtream Login</h2>
                <input type="text" id="iptv_url" class="focusable" placeholder="http://server.com:80" style="width:100%; padding:15px; margin:10px 0; background:#060d14; border:none; color:white; border-radius:10px;">
                <input type="text" id="iptv_user" class="focusable" placeholder="Username" style="width:100%; padding:15px; margin:10px 0; background:#060d14; border:none; color:white; border-radius:10px;">
                <input type="password" id="iptv_pass" class="focusable" placeholder="Password" style="width:100%; padding:15px; margin:10px 0; background:#060d14; border:none; color:white; border-radius:10px;">
                <button class="focusable" onclick="connect()" style="width:100%; padding:18px; background:var(--accent); color:white; border:none; font-weight:800; border-radius:12px; margin-top:20px;">CONNECT</button>
            </div>
        </section>
    </main>

    <div id="player-layer">
        <video id="v-engine" controls autoplay></video>
        <button class="focusable" onclick="closePlayer()" style="position:fixed; top:30px; left:30px; padding:15px 30px; background:rgba(0,0,0,0.5); border:1px solid white; color:white; border-radius:12px;">Back</button>
    </div>

<script>
    const TMDB_KEY = "c78abeb00aa64f93fd7b516cb9bd180e";
    const PROXY = "https://layasync-proxy.layasync.workers.dev/?url=";
    let auth = null;
    let currentFocus = null;

    // --- 1. SPATIAL & IR ENGINE ---
    function setFocus(el) {
        if (!el || currentFocus === el) return;
        if (currentFocus) currentFocus.classList.remove('focused');
        currentFocus = el;
        currentFocus.classList.add('focused');
        currentFocus.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
    }

    function moveFocus(dir) {
        const all = Array.from(document.querySelectorAll('.view.active .focusable, aside .focusable, #player-layer .focusable'));
        const curRect = currentFocus.getBoundingClientRect();
        let minDistance = Infinity;
        let target = null;

        all.forEach(el => {
            if (el === currentFocus) return;
            const r = el.getBoundingClientRect();
            let isMatch = false;

            if (dir === 'up' && r.bottom <= curRect.top + 5) isMatch = true;
            if (dir === 'down' && r.top >= curRect.bottom - 5) isMatch = true;
            if (dir === 'left' && r.right <= curRect.left + 5) isMatch = true;
            if (dir === 'right' && r.left >= curRect.right - 5) isMatch = true;

            if (isMatch) {
                const dist = Math.hypot(r.left - curRect.left, r.top - curRect.top);
                if (dist < minDistance) { minDistance = dist; target = el; }
            }
        });
        if (target) setFocus(target);
    }

    // --- IR & GAMEPAD POLLING LOOP ---
    // This solves the IR remote "Mouse Mode" issue on Tizen
    function pollInput() {
        const gamepads = navigator.getGamepads();
        for (const gp of gamepads) {
            if (!gp) continue;
            // D-Pad mapping (Buttons 12-15)
            if (gp.buttons[12].pressed) moveFocus('up');
            if (gp.buttons[13].pressed) moveFocus('down');
            if (gp.buttons[14].pressed) moveFocus('left');
            if (gp.buttons[15].pressed) moveFocus('right');
            if (gp.buttons[0].pressed) currentFocus.click(); // 'A' or 'Enter'
        }
        requestAnimationFrame(pollInput);
    }
    pollInput();

    // Standard Keyboard / Bluetooth Listeners
    window.addEventListener('keydown', e => {
        const key = e.keyCode;
        // Map Tizen IR specific codes
        if ([37, 38, 39, 40, 13, 10009].includes(key)) e.preventDefault();
        
        if (key === 38) moveFocus('up');
        if (key === 40) moveFocus('down');
        if (key === 37) moveFocus('left');
        if (key === 39) moveFocus('right');
        if (key === 13) currentFocus.click();
        if (key === 10009) closePlayer(); // Back button
    });

    // Mouse Hover Support (Works with IR Virtual Cursor)
    document.addEventListener('mouseover', e => {
        const target = e.target.closest('.focusable');
        if (target) setFocus(target);
    });

    // --- 2. LOGIC ---
    async function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        if(id === 'home') await initHome();
        setTimeout(() => setFocus(document.querySelector('.view.active .focusable') || document.querySelector('aside .focusable')), 100);
    }

    async function connect() {
        auth = { url: document.getElementById('iptv_url').value, user: document.getElementById('iptv_user').value, pass: document.getElementById('iptv_pass').value };
        showView('home');
    }

    async function initHome() {
        document.getElementById('loader').style.display = 'flex';
        const tmdb = await fetch(`https://api.themoviedb.org/3/trending/movie/day?api_key=${TMDB_KEY}`);
        const data = await tmdb.json();
        const top = data.results[0];
        
        document.getElementById('home-hero').style.backgroundImage = `url(https://image.tmdb.org/t/p/original${top.backdrop_path})`;
        document.getElementById('hero-title').innerText = top.title;
        document.getElementById('hero-desc').innerText = top.overview;

        fillRow('row-trending', data.results);
        if (auth) {
            const res = await fetch(PROXY + encodeURIComponent(`${auth.url}/player_api.php?username=${auth.user}&password=${auth.pass}&action=get_vod_streams`));
            const items = await res.json();
            fillRow('row-server', items.slice(0, 12), true);
        }
        document.getElementById('loader').style.display = 'none';
    }

    function fillRow(id, items, isServer = false) {
        const row = document.getElementById(id); row.innerHTML = '';
        items.forEach(i => {
            const div = document.createElement('div');
            div.className = 'card focusable';
            const img = isServer ? (i.stream_icon || i.cover) : `https://image.tmdb.org/t/p/w500${i.backdrop_path}`;
            div.style.backgroundImage = `url(${img})`;
            div.innerHTML = `<div class="card-label">${i.name || i.title}</div>`;
            div.onclick = () => isServer ? playItem(i) : null;
            row.appendChild(div);
        });
    }

    async function loadLib(type) {
        document.getElementById('loader').style.display = 'flex';
        const action = type === 'movies' ? 'get_vod_categories' : 'get_series_categories';
        const res = await fetch(PROXY + encodeURIComponent(`${auth.url}/player_api.php?username=${auth.user}&password=${auth.pass}&action=${action}`));
        const data = await res.json();
        
        document.getElementById('lib-title').innerText = type.toUpperCase();
        const grid = document.getElementById('lib-grid'); grid.innerHTML = '';
        data.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'cat-card focusable';
            div.style.height = '80px'; div.style.background = 'var(--surface)'; div.style.borderRadius = '10px'; div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.justifyContent = 'center'; div.style.fontWeight = 'bold';
            div.innerText = cat.category_name;
            div.onclick = () => loadItems(type === 'movies' ? 'get_vod_streams' : 'get_series', cat.category_id);
            grid.appendChild(div);
        });
        showView('lib');
        document.getElementById('loader').style.display = 'none';
    }

    async function loadItems(action, id) {
        document.getElementById('loader').style.display = 'flex';
        const res = await fetch(PROXY + encodeURIComponent(`${auth.url}/player_api.php?username=${auth.user}&password=${auth.pass}&action=${action}&category_id=${id}`));
        const data = await res.json();
        const grid = document.getElementById('lib-grid'); grid.innerHTML = '';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card focusable';
            div.style.width = '100%'; div.style.minWidth = 'unset';
            div.style.backgroundImage = `url(${item.stream_icon || item.cover})`;
            div.innerHTML = `<div class="card-label">${item.name}</div>`;
            div.onclick = () => playItem(item);
            grid.appendChild(div);
        });
        document.getElementById('loader').style.display = 'none';
        setFocus(grid.firstChild);
    }

    function playItem(item) {
        const url = `${auth.url}/movie/${auth.user}/${auth.pass}/${item.stream_id}.${item.container_extension || 'mkv'}`;
        document.getElementById('player-layer').style.display = 'block';
        const v = document.getElementById('v-engine'); v.src = url; v.play();
    }

    function closePlayer() {
        const v = document.getElementById('v-engine'); v.pause(); v.src = "";
        document.getElementById('player-layer').style.display = 'none';
    }

    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.onclick = () => {
            const p = btn.dataset.page;
            if (p === 'movies' || p === 'shows') loadLib(p);
            else showView(p);
        };
    });

    setFocus(document.querySelector('.nav-item'));
    setTimeout(() => document.getElementById('loader').style.display = 'none', 1500);
</script>
</body>
</html>